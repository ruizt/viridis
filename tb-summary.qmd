---
title: "Results summary"
execute:
  echo: false
  warning: false
  message: false
format: docx
---

```{r}
library(tidyverse)
library(nlme)
library(pander)
load('data/tb-results.RData')
```

## Model overview

Model: $$Y_{ihdk} = \mu + \tau_i + f_i(h, d) + g_{ik}(h) + \epsilon_{ik}(h, d)
\quad
\begin{cases}
i = 1, 2 \\
h = 0, 1, \dots, 23 \\
d = 182, \dots, 237 \\
\sum_i \tau_i = 0 \\
\epsilon_{ik}(h, d) \sim AR1 \\
k = 1, \dots, n_i
\end{cases}$$

The response $Y_{itdk}$ represents body temperature $T_b$ for pregnancy status $i$ at time of day $t$ on day $d$ for snake $k$. $\mu$ represents the population mean body temperature. The fixed parameters $\tau_i$ represent deviations from the population mean body temperature corresponding to each pregnancy status, and are subject to a sum constraint, so that $\tau_1 = -\tau_2$.

The function $f_i$ represents population-level temporal and seasonal deviations in mean body temperature for pregnancy status $i$, and is represented in the model by Fourier basis expansions $\left\{\phi_j^{(h)}\right\}$ and $\left\{\phi_l^{(d)}\right\}$ corresponding to time of day and day, respectively, plus all two- and three-way interaction terms between basis functions and group, yielding the representation: $$f_i = \sum_j \left(\alpha_j + \tilde{\alpha}_{ij})\right) \cdot \phi_j^{(h)} + 
  \sum_l \left(\beta_l + \tilde{\beta}_{il}\right) \cdot \phi_l^{(d)} + 
  \sum_i \sum_l \left(\gamma_{jl} + \tilde{\gamma}_{ijl}\right) \cdot \phi_j^{(h)}\phi_l^{(d)}$$
All parameters in the above expression are fixed and the interaction terms are subject to a sum constraint: $\sum_i \tilde{\alpha}_{ij} = \sum_i \tilde{\beta}_{il} = \sum_j\sum_l \tilde{\gamma}_{ijl} = 0$. Three basis pairs spanning the period 0-23 are used for the time of day term, and a single basis pair spanning the annual period 1-365 is used for the day term.

The function $g_{ik}$ gives individual-level temporal deviations from the group-level mean in group $i$ for snake $k$, and is represented using the aforementioned basis expansion $\left\{\phi_j^{(h)}\right\}$ with random coefficients: $$g_{ik} = \sum_j \delta_{jik} \cdot \phi_j^{(h)} \qquad\text{where}\qquad \delta_{jik} \stackrel{iid}{\sim} N\left(0, \sigma^2_{j}\right)$$

Lastly, the error term $\epsilon_{ik}(h, d)$ is an autoregressive process of order 1. Expressed as a function of consecutive time-points $t$ corresponding to each unique combination of hour and day arranged in sequence: $$\epsilon_{ik}(t) = \phi \cdot \epsilon_{ik}(t - 1) + w_t \qquad\text{where}\qquad w_t \stackrel{iid}{\sim} N\left(0, \sigma^2\right)$$

The model thus has, accounting for the sum constraints, a total of 42 fixed free parameters: the grand mean $\mu$, $\tau_1$, 6 $\alpha_j$ and 6 $\tilde{\alpha}_{1j}$, 2 $\beta_l$ and 2 $\tilde{\beta}_{1l}$, 12 $\gamma_{jl}$ and 12 $\tilde{\gamma}_{1jl}$. The correlation structure for the random portion of the model comprises 8 parameters: 6 variance parameters $\sigma^2_{j}$, the autoregressive parameter $\phi$, and the residual variance $\sigma^2$.

<!-- Several quantities of interest can be derived from the model by manipulating the basis representations of $f_i$ and $g_{ik}$. The interaction-term parameters in $f_i$ can be dropped to obtain population- or group-level temporal and seasonal fluctuations in mean body temperature, and the random coefficients can be added to any of these to obtain individual-level fluctuations. -->

<!-- $$\begin{align} -->
<!-- \mu + \sum_j \alpha_j \cdot \phi_j^{(h)}  -->
<!-- &\quad\text{(population daily fluctuations)}\\ -->
<!-- \mu + \sum_l \beta_l \cdot \phi_l^{(d)}  -->
<!-- &\quad\text{(population seasonal fluctuations)}\\ -->
<!-- \mu + \sum_j \alpha_j \cdot \phi_j^{(t)} +  -->
<!--     \sum_l \beta_l  \cdot \phi_l^{(d)} +  -->
<!--     \sum_i \sum_l \gamma_{jl} \cdot \phi_j^{(h)}\phi_l^{(d)} -->
<!-- &\quad\text{(population mean over time)}\\ -->
<!-- \mu + \tau_i + \sum_j \left(\alpha_j + \tilde{\alpha}_{ij})\right) \cdot \phi_j^{(h)} -->
<!-- &\quad\text{(group daily fluctuations)} \\ -->
<!-- \mu + \tau_i + \sum_j \left(\beta_l + \tilde{\beta}_{il})\right) \cdot \phi_j^{(d)} -->
<!-- &\quad\text{(group seasonal fluctuation)} \\ -->
<!-- \mu + \tau_i + f_i(h, d)  -->
<!-- &\quad\text{(group means over time)} \\ -->
<!-- \mu + \tau_i + \sum_j \left(\alpha_j + \tilde{\alpha}_{ij} + \delta_{ijk}\right) \cdot \phi_j^{(t)}  -->
<!-- &\quad\text{(individual daily fluctuations)} \\ -->
<!-- \mu + \tau_i + f_i(h, d) + g_{ik}(h) -->
<!-- &\quad\text{(individual means over time)} -->
<!-- \end{align}$$ -->

Parameters are estimated by REML.

## Results

The model was fit to 55 consecutive days of hourly observations of body temperatures for 7 pregnant and 6 non-pregnant snakes.

```{r, fig.width = 12, fig.height= 12}
p_raw
```

The ANOVA table below summarizes conditional F tests for fixed terms and indicates most model terms explained significant variability in mean body temperatures, except for the day-group and day-group-hour interaction terms. This suggests that estimated differences in body temperature associated with pregnancy status do not depend significantly on seasonal shifts.

```{r}
anova(fit, type = 'sequential')[-1, ] %>%
  pander()
```


Fitted body temperatures over time by snake show substantial variability in daily fluctuations by snake. It should be noted that the model did not estimate seasonal fluctuations at the snake level, so the shifts by day shown in the figure are identical within pregnancy group.
```{r}
p_lev1_pred
```

Population-level time courses with Bonferroni-adjusted 95% confidence bands are shown below by group. This displays clearly the estimated seasonal shifts by pregnancy group.
```{r}
p_lev0_pred_date
```

Visualizing the same information by hour of day indicates: (a) temperature differences are more pronounced at night; (b) estimated temperatures for pregnant snakes show a much more dramatic seasonal shift toward lower morning body temperatures.
```{r}
p_lev0_pred_hour
```

Lastly, estimated differences between pregnant and non-pregnant mean body temperatures by hour and day with a Bonferroni-adjusted 95% confidence band are shown below.
```{r}
p_diff
```

## Parameter estimates

### Fixed parameters

```{r}
fit_sum$tTable[, 1:2] %>% pander(digits = 3) # fixed effects
```

### Variance parameters

```{r}
VarCorr(fit) %>%
  as.table() %>%
  pander(digits = 3)
```

The autoregressive parameter was estimated to be $\hat{\phi}$ = `r coef(fit$modelStruct$corStruct, unconstrained = F)` 

### Estimated random parameters

```{r}
ranef(fit) %>%
  pander(digits = 3)
```